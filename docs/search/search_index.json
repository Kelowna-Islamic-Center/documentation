{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Welcome to MkDocs","text":"<p>For full documentation visit mkdocs.org.</p>"},{"location":"#commands","title":"Commands","text":"<ul> <li><code>mkdocs new [dir-name]</code> - Create a new project.</li> <li><code>mkdocs serve</code> - Start the live-reloading docs server.</li> <li><code>mkdocs build</code> - Build the documentation site.</li> <li><code>mkdocs -h</code> - Print help message and exit.</li> </ul>"},{"location":"#project-layout","title":"Project layout","text":"<pre><code>mkdocs.yml    # The configuration file.\ndocs/\n    index.md  # The documentation homepage.\n    ...       # Other markdown pages, images and other files.\n</code></pre>"},{"location":"server-side/","title":"Back-end Architecture Overview","text":"<p>The server-side of the Kelowna Islamic Center (KIC) ecosystem is powered by Firebase Cloud Functions, Firestore, and Cloud Tasks.  </p> <p>These backend services handle the automation, scheduling, and delivery of notifications and content to the mobile app, web kiosk, and other client platforms.</p> <p>This section of the documentation provides a complete reference for how these server-side processes work, how they are structured, and how to extend or troubleshoot them.</p>"},{"location":"server-side/#purpose-of-server-side-functions","title":"Purpose of Server-Side Functions","text":"<p>The KIC mobile and web platforms rely on accurate, timely, and consistent information. Server-side functions ensure that:</p> <ul> <li>Prayer reminders are fetched, scheduled, and delivered without manual intervention.</li> <li>Announcements are instantly broadcast to the community when new updates are posted.</li> <li>Notifications are localized to user preffered languages and properly routed to users who have opted in.</li> <li>System complexity (timezones, retries, scheduling, and message formatting) is all handled automatically in the backend.</li> </ul>"},{"location":"server-side/#key-components","title":"Key Components","text":"<p>1. Get Prayer Times</p> <ul> <li>Fetches latest Athan and Iqamah times accurately for each prayer.</li> <li>Resolve prayer times based on selected calculation method. </li> <li>See: Prayer Times API</li> </ul> <p>2. Announcements</p> <ul> <li>Firestore-backed system for storing announcements.  </li> <li>Automatically triggers notifications when new announcements are created.  </li> <li>See: Announcements</li> </ul> <p>3. Prayer Reminders</p> <ul> <li>Daily scheduler (<code>prayerTimesAlertScheduler</code>) fetches and queues reminders.  </li> <li>Task queue processor (<code>sendPrayerAlert</code>) dispatches localized push notifications for Athan and Iqamah.  </li> <li>See: Prayer Reminders</li> </ul> <p>4. Supporting Infrastructure</p> <ul> <li>Firestore \u2013 Persistent storage of announcements.  </li> <li>Cloud Tasks \u2013 Time-precise delivery of prayer notifications.  </li> <li>Cloud Messaging (FCM) \u2013 Notification delivery to mobile apps.</li> </ul>"},{"location":"server-side/#developer-notes","title":"Developer Notes","text":"<ul> <li>All notifications are topic-based (<code>announcements</code>, <code>athanAlert</code>, <code>iqamah*MinuteAlert</code>, etc.), giving clients granular control over what to subscribe to.</li> <li>Timezones are managed differently on client where it is local masjid time (<code>America/Vancouver</code>) and the server where it is server region (<code>America/Chicago</code>).</li> <li>Functions are written to fail gracefully (e.g., no notification if config is missing, retries for transient errors).</li> <li>This system is event-driven and fully automated \u2014 once deployed and configured, minimal admin intervention is needed.</li> </ul>"},{"location":"server-side/#next-steps","title":"Next Steps","text":"<p>Explore each feature in detail:</p> <ul> <li>Cloud Functions Overview</li> <li>Prayer Times API</li> <li>Announcements </li> <li>Prayer Reminders</li> </ul>"},{"location":"server-side/announcements/","title":"Announcements","text":"<p>The announcements system is used by KIC to keep the community informed about events, updates, or important notices. Announcements can be found in the announcments tab on the mobile app or on the sliding carousel on the kiosk display.</p> <p>They are stored in a Firestore database and automatically trigger notifications to client applications whenever a new announcement is added.</p> <p>Admins can create announcements within the Mobile App's admin tools and specify which platforms (mobile or web) will receive the announcmenet. </p> <p>This guide explains how announcements are structured, stored, and delivered through Cloud Functions.</p>"},{"location":"server-side/announcements/#firestore-storage","title":"Firestore Storage","text":"<p>All created announcements are stored in a Firestore collection under:</p> <pre><code>/announcements/{docId}\n</code></pre> <p>Each announcement document contains the following fields:</p> Field Type Description <code>title</code> string The title of the announcement <code>description</code> string The full content of the announcement <code>platforms</code> array Platforms to notify (e.g., <code>[\"mobile\"]</code>, <code>[\"web\"]</code>, or <code>[\"web\", \"mobile\"]</code>). If missing or invalid, ignored. <code>timeStamp</code> timestamp Server-generated timestamp automatically set when the announcement is added. Don't set this manually."},{"location":"server-side/announcements/#how-announcments-are-sent","title":"How Announcments are Sent","text":"<p>The <code>announcementAlert</code> function manages the full lifecycle of announcements. This works in the following steps:</p> <p>1. Create Announcement</p> <p>When a new document is added to <code>/announcements</code>, the <code>announcementAlert</code> Cloud Function triggers.</p> <p>Example Firestore entry:</p> <pre><code>{\n    \"title\": \"Community Dinner\",\n    \"description\": \"Join us for a community dinner this Friday after Maghrib.\",\n    \"platforms\": [\"mobile\"]\n}\n</code></pre> <p>2. Notification Processing</p> <p>The function sets a server-side <code>timeStamp</code> field with a time stamp of when the announcement is created.</p> <p>Notifications are only sent if the <code>platforms</code> array includes <code>\"mobile\"</code>. If the <code>platforms</code> field is missing or not an array, no notification is sent (fails silently).</p> <p>3. Notification Payload</p> <p>A Firebase Cloud Messaging (FCM) payload is generated and sent. This payload is then received by clients that are subscribed to announcements (announcements enabled in settings on mobile).</p> <pre><code>{\n    \"topic\": \"announcements\",\n    \"notification\": {\n        \"title\": \"Community Dinner - New Announcement\",\n        \"body\": \"Join us for a community dinner this Friday after Maghrib.\",\n        \"android_channel_id\": \"announcements_channel\"\n    },\n    \"data\": {\n        \"notificationType\": \"announcements\",\n        \"topic\": \"announcements\"\n    }\n}\n</code></pre>"},{"location":"server-side/announcements/#notes","title":"Notes","text":"<ul> <li>Announcements are event-driven; no manual triggering is required once a document is created.</li> <li>The workflow can be extended in the future to include:<ul> <li>Scheduled or expiring announcements (e.g., auto-remove old announcements).</li> <li>Rich media (images, links) in notifications.</li> </ul> </li> </ul>"},{"location":"server-side/announcements/#common-issues-troubleshooting","title":"Common Issues &amp; Troubleshooting","text":"<p>Here are some common problems you may encounter when working with announcements, and how to resolve them:</p> <p>1. No Notification Sent</p> <ul> <li>Cause: The <code>platforms</code> field is missing or not set to <code>[\"mobile\"]</code>.</li> <li>Fix: Ensure your Firestore document includes <code>\"platforms\": [\"mobile\"]</code>.</li> </ul> <p>2. Timestamp Not Appearing</p> <ul> <li>Cause: The announcement was created manually with a <code>timeStamp</code> field.</li> <li>Fix: Let the function set <code>Timestamp.now()</code> automatically. Remove any manually set values.</li> </ul> <p>3. Invalid Android Channel ID</p> <ul> <li>Cause: The environment variable <code>ANDROID_CHANNEL_ID_ANNOUNCEMENTS</code> was not configured.</li> <li> <p>Fix: Set it using:</p> <p><code>bash  firebase functions:config:set ANDROID_CHANNEL_ID_ANNOUNCEMENTS=\"announcements_channel\"</code></p> </li> </ul> <p>4. FCM Send Errors in Logs</p> <ul> <li>Cause: Firebase project may not have Cloud Messaging enabled, or credentials are invalid.</li> <li> <p>Fix:</p> <ul> <li>Ensure Firebase Cloud Messaging is enabled in the Firebase Console.</li> <li>Regenerate your service account key if necessary.</li> <li>Check logs with <code>npm run logs</code> for specific error codes.</li> </ul> </li> </ul>"},{"location":"server-side/cloud-functions/","title":"Cloud Functions Overview","text":"<p>This application makes use of Firebase Cloud Functions which is a complete serverless solution that runs on Google Cloud, requiring no server maintenance.</p> <p>The functions are simple JavaScript (JS) functions that are run on the server based on triggers.</p> <p>You can find the full source code for these functions along with all the server-side logic that powers the mobile app, kiosk app, and the backend services for prayer times, announcements, and notifications here:</p> <p> Kelowna-Islamic-Center/cloud-functions</p> <p>Info</p> <p>To learn more about Firebase Cloud Functions read the official Firebase guide.</p>"},{"location":"server-side/cloud-functions/#purpose-of-cloud-functions","title":"Purpose of Cloud Functions","text":"<p>The current cloud functions are responsible for handling all server-side logic such as:</p> <ul> <li>Fetching daily prayer times from The BCMA and Islamic Finder APIs.</li> <li>Scheduling and sending notifications for prayer times (athan and iqamah) and announcements.</li> <li>Serving prayer times via HTTP endpoints to clients.</li> <li>Handling any other server-side logic.</li> </ul> <p>The cloud functions do not handle authentication as Firebase provides the managed Firebase Authentication service which already handles all authentication requests, tokens, etc.</p>"},{"location":"server-side/cloud-functions/#cloud-messaging-notifications","title":"Cloud Messaging Notifications","text":"<p>Cloud functions can also send cloud notifications that are delivered over the internet rather than being locally triggered. These \"cloud notifications\" are handled through Firebase Cloud Messaging (FCM).</p> <p>Clients receive notifications by subscribing to topics. These topics are agreed beforehand and determine which notifications the client will receive. For example, if a mobile app client is subscribed to the <code>announcements</code> topic, it will receive a notification if a cloud function passes a notification payload to FCM that contains the <code>announcements</code> topic.</p> <p>Info</p> <p>To learn more about Firebase Cloud Messaging read the official Firebase guide.</p>"},{"location":"server-side/cloud-functions/#active-functions-summary","title":"Active Functions Summary","text":"<p>The following functions are currently active.</p> <p>Detailed documentation for each function can be found under the \"Cloud Functions Reference\" category or by clicking the links below.</p> Function Type Trigger Purpose <code>announcementAlert</code> Firestore Document created Sends announcement notifications <code>prayerTimesAlertScheduler</code> Scheduled Daily at 07:00 UTC (00:00 PST) Queues prayer notifications <code>sendPrayerAlert</code> Task Queue Dispatched by scheduler (when prayer reminder notification should be sent) Sends localized prayer notifications <code>prayerTimesFetch</code> HTTP GET request Returns structured prayer times"},{"location":"server-side/prayer-reminders/","title":"Prayer Reminders","text":"<p>The Prayer Reminders system delivers sheduled notifications for Athan and Iqamah reminders to the mobile app. These notifications used to be handled locally on device however due to recent software updates on both Android and iOS this has been moved to the cloud to allow for more control over notifications.</p> <p>It\u2019s implemented with two Cloud Functions that work together:</p> <p>Every day at 07:00 UTC (12:00 AM PST) the <code>prayerTimesAlertScheduler</code> function runs and schedules all the notification jobs for the day through Cloud Tasks.</p> <p>Once a its time for notification to be delivered, the notification job is run in Cloud Tasks by running the <code>sendPrayerAlert</code> function which then sends the localized notifications to clients via FCM.</p>"},{"location":"server-side/prayer-reminders/#topics-subscriptions-fcm","title":"Topics &amp; Subscriptions (FCM)","text":"<p>Clients receive reminders by subscribing to topics:</p> <ul> <li>Athan: <code>athanAlert</code></li> <li>Iqamah (reminders): <code>iqamah5MinuteAlert</code>, <code>iqamah10MinuteAlert</code>, <code>iqamah15MinuteAlert</code>, <code>iqamah20MinuteAlert</code>, <code>iqamah30MinuteAlert</code>, <code>iqamah45MinuteAlert</code></li> <li>Language filter: <code>lang-&lt;locale&gt;</code> (e.g., <code>lang-en</code>, <code>lang-ar</code>, \u2026)</li> </ul> <p>Note: Iqamah notifications additionally require users to be on the <code>iqamahAlert</code> topic (opt-in gate).</p>"},{"location":"server-side/prayer-reminders/#important-notes","title":"Important Notes","text":"<ul> <li>Friday handling: When its Friday, the system skips <code>duhr</code> and <code>jumuah</code> is used instead. The opposite behaviour exists on non-friday days.</li> <li>Shurooq is skipped in notification scheduling as it is not a mandatory prayer.</li> <li>Locales: Notification strings are generated per entry in <code>locale.json</code>.</li> <li>Time formatting: All times are in the human-readable format (e.g., <code>1:30 PM</code>).</li> </ul>"},{"location":"server-side/prayer-reminders/#common-issues-troubleshooting","title":"Common Issues &amp; Troubleshooting","text":"<p>1) No notifications are delivered</p> <ul> <li>Cause: Devices aren\u2019t subscribed to the expected topics.  </li> <li>Fix: Ensure the app subscribes users to <code>athanAlert</code> and/or the specific <code>iqamah*MinuteAlert</code> topics, plus <code>lang-&lt;locale&gt;</code>. For iqamah, also require <code>iqamahAlert</code>.</li> </ul> <p>2) Iqamah reminders don\u2019t fire</p> <ul> <li>Cause: Users didn\u2019t opt-in to <code>iqamahAlert</code>, or the minute-specific topic name doesn\u2019t match.  </li> <li>Fix: Verify both <code>iqamahAlert</code> and the minute topic (e.g., <code>iqamah15MinuteAlert</code>) are subscribed.</li> </ul> <p>3) Scheduler doesn\u2019t run</p> <ul> <li>Cause: Cloud Scheduler or required Google Cloud APIs are disabled; billing plan insufficient.  </li> <li>Fix: Enable Cloud Scheduler and Cloud Tasks, ensure Blaze plan if required, and confirm the function is deployed in the intended region.</li> </ul> <p>4) Times look off (early/late)</p> <ul> <li>Cause: Timezone mix-ups between America/Vancouver and America/Chicago conversions.  </li> <li>Fix: Check logs for parsed prayer times and scheduled UTC times. Confirm server region and conversion logic.</li> </ul> <p>5) Missing sounds or channel errors</p> <ul> <li>Cause: Android channel IDs not set, or iOS sound not bundled.  </li> <li>Fix: Set <code>ANDROID_CHANNEL_ID_ATHAN_ALERTS</code> / <code>ANDROID_CHANNEL_ID_IQAMAH_ALERTS</code>. Ensure iOS sound files are included in the app.</li> </ul> <p>6) FCM errors in logs</p> <ul> <li>Cause: Cloud Messaging not enabled or service account permissions incorrect.  </li> <li>Fix: Validate FCM setup in Firebase Console and recheck service account credentials.</li> </ul>"},{"location":"server-side/prayer-times-api/","title":"Prayer Times API","text":"<p>Since the Kelowna Islamic Center is part of the BC Muslim Association (BCMA), all prayer times come directly from the BCMA API. However, this data is not usable directly and needs to be further processed into a JSON format that the mobile app and the kiosk app can better handle.</p> <p>All clients, like the mobile app and the kiosk app, periodically check the KIC API endpoint which is served by the <code>prayerTimesFetch</code> cloud function. This cloud function makes the request to the BCMA API and parses it into a cleaner format that the applications then receive.</p> <p>Note</p> <p>The application architecture supports any API if required, not just the BCMA API. All that is required is that the <code>prayerTimesFetch</code> function be modified to accommodate the new API.</p> <p>Info</p> <p>You can read more about cloud functions and this specific cloud function on the Cloud Functions page.</p>"},{"location":"server-side/prayer-times-api/#the-bcma-api","title":"The BCMA API","text":"<p>The BCMA API endpoint for Kelowna Islamic Center (BCMA Organization 7) is:</p> <pre><code>https://org.thebcma.com/api/Prayertimes/GetPrayertimeByDate?organizationId=7&amp;dt={date}\n</code></pre> <ul> <li><code>{date}</code> formatted as <code>MM-DD-YYYY</code> in Pacific Time. The cloud function, when making its request, is configured to either use today's date or tomorrow's date.</li> </ul>"},{"location":"server-side/prayer-times-api/#response-format","title":"Response Format","text":"<p>The BCMA API responds with a key-only list of prayer times:</p> <pre><code>{\n  \"$id\": \"1\",\n  \"id\": 6444,\n  \"prayerDate\": \"08/26/2022\",\n  \"fajr\": \"4:02:00 AM\",\n  \"fajrIqama\": \"5:00:00 AM\",\n  \"sunrise\": \"6:03:00 AM\",\n  \"zawal\": \"\",\n  \"duhr\": \"1:04:00 PM\",\n  \"duhrIqama\": \"1:30:00 PM\",\n  \"asr\": \"5:48:00 PM\",\n  \"asrIqama\": \"6:15:00 PM\",\n  \"maghreb\": \"8:00:00 PM\",\n  \"maghrebIqama\": \"\",\n  \"isha\": \"9:35:00 PM\",\n  \"ishaIqama\": \"9:50:00 PM\",\n  \"organizationID\": 7,\n  \"calendarDate\": \"2025-08-26T00:00:00\",\n  \"firstJumma\": \"1:30:00 PM\",\n  \"secondJumma\": \"\",\n  \"traveeh\": \"\",\n  \"disclaimer\": null,\n  \"cacheKey\": \"Prayertime_7_8/26/2025 12:00:00 AM\"\n}\n</code></pre> <p>Out of all of these keys, only the essential prayer and iqamah keys are parsed and formatted. The cloud function then also queries the Islamic Finder API for hanbali time, as KIC users use both hanafi and hanbali times (BCMA only provides hanafi).</p> <p>After all processing is complete, the cloud function outputs the following result which is usable by the mobile and kiosk apps.</p> <pre><code>[\n  {\n    \"id\": \"fajr\",\n    \"start\": \"04:02 AM\",\n    \"iqamah\": \"05:00 AM\",\n    \"name\": \"Fajr - \u0627\u0644\u0641\u062c\u0631\"\n  },\n  {\n    \"id\": \"shurooq\",\n    \"start\": \"06:03 AM\",\n    \"iqamah\": \"06:03 AM\",\n    \"name\": \"Shurooq - \u0627\u0644\u0634\u0631\u0648\u0642\"\n  },\n  {\n    \"id\": \"duhr\",\n    \"start\": \"01:04 PM\",\n    \"iqamah\": \"01:30 PM\",\n    \"name\": \"Duhr - \u0627\u0644\u0638\u0647\u0631\"\n  },\n  {\n    \"id\": \"asr\",\n    \"start\": \"05:48 PM\",\n    \"iqamah\": \"06:15 PM\",\n    \"name\": \"Asr - \u0627\u0644\u0639\u0635\u0631\"\n  },\n  {\n    \"id\": \"maghrib\",\n    \"start\": \"08:00 PM\",\n    \"iqamah\": \"08:00 PM\",\n    \"name\": \"Maghrib - \u0627\u0644\u0645\u063a\u0631\u0628\"\n  },\n  {\n    \"id\": \"isha\",\n    \"start\": \"09:35 PM\",\n    \"iqamah\": \"09:50 PM\",\n    \"name\": \"Isha - \u0627\u0644\u0639\u0634\u0627\u0621\"\n  },\n  {\n    \"id\": \"jumuah\",\n    \"start\": \"01:30 PM\",\n    \"iqamah\": \"01:30 PM\",\n    \"name\": \"Jumuah - \u0627\u0644\u062c\u0645\u0639\u0629\"\n  }\n]\n</code></pre> <p>Once again, full documentation of the prayerTimesFetch cloud function is available with details on what parameters the API endpoint accepts and what the output looks like.</p>"},{"location":"server-side/cloud-functions/announcement-alert/","title":"announcementAlert","text":"<p>Type: Firestore Trigger (onDocumentCreated)</p> <p>Path: <code>/announcements/{docId}</code></p>"},{"location":"server-side/cloud-functions/announcement-alert/#description","title":"Description","text":"<p>Triggered whenever a new document is created in the <code>announcements</code> collection.  </p> <p>This function:</p> <ul> <li>Adds a <code>timeStamp</code> field to the new document with the current server time.</li> <li>If the announcement is intended for the mobile platform, it sends a push notification to the announcements topic via Firebase Cloud Messaging.</li> </ul>"},{"location":"server-side/cloud-functions/announcement-alert/#accepted-methods","title":"Accepted Methods","text":"<ul> <li>Trigger: Firestore document creation</li> </ul>"},{"location":"server-side/cloud-functions/announcement-alert/#parameters","title":"Parameters","text":"Name Type Required Description <code>docId</code> string Yes The Firestore document ID of the announcement. <code>platforms</code> string[] No Platforms the announcement applies to. Must include atleast <code>\"mobile\"</code>, <code>\"web\"</code>, or both to trigger notifications. <code>title</code> string Yes The announcement title. <code>description</code> string Yes Announcement body text."},{"location":"server-side/cloud-functions/announcement-alert/#example-notification-payload","title":"Example Notification Payload","text":"<p>This notification payload is sent to Firebase Messaging which delivers it to the mobile apps and the web kiosk app.</p> <pre><code>{\n  \"topic\": \"announcements\",\n  \"notification\": {\n    \"title\": \"{title} - New Announcement\",\n    \"body\": \"{description}\",\n    \"android_channel_id\": \"ANDROID_CHANNEL_ID_ANNOUNCEMENTS\"\n  },\n  \"data\": {\n    \"notificationType\": \"announcements\",\n    \"topic\": \"announcements\"\n  }\n}\n</code></pre>"},{"location":"server-side/cloud-functions/prayer-times-alert-scheduler/","title":"prayerTimesAlertScheduler","text":"<p>Type: Scheduled Function (onSchedule)</p> <p>Schedule: Every day at 07:00 UTC (12:00 AM PST)</p>"},{"location":"server-side/cloud-functions/prayer-times-alert-scheduler/#description","title":"Description","text":"<p>This function runs daily to:</p> <ul> <li>Fetch the prayer times from a configured API.</li> <li>Build notification payloads for athan and iqamah reminders.</li> <li>Schedule tasks in Firebase Task Queues to send the notifications at the appropriate times.</li> </ul>"},{"location":"server-side/cloud-functions/prayer-times-alert-scheduler/#environment-variables","title":"Environment Variables","text":"<ul> <li><code>ANDROID_CHANNEL_ID_ATHAN_ALERTS</code></li> <li><code>ANDROID_CHANNEL_ID_IQAMAH_ALERTS</code></li> <li><code>PRAYER_TIMES_FETCH_URL</code></li> </ul>"},{"location":"server-side/cloud-functions/prayer-times-alert-scheduler/#behavior","title":"Behavior","text":"<ol> <li>Fetches prayer times for the current day.</li> <li>Excludes Shurooq.</li> <li>On Fridays:</li> <li>Excludes Duhr</li> <li>Includes Jumuah</li> <li>Converts times to America/Chicago (server timezone).</li> <li>Enqueues payloads into the task queue for <code>sendPrayerAlert</code>.</li> </ol>"},{"location":"server-side/cloud-functions/prayer-times-alert-scheduler/#example-task-payload","title":"Example Task Payload","text":"<p>This task payload is later parsed by sendPrayerAlert when it is activated by the cloud scheduler. It provides it with context on what notification to send and where to send it when it is activated.</p> <pre><code>{\n  \"id\": \"fajr\",\n  \"type\": \"iqamah\",\n  \"androidChannel\": \"ANDROID_CHANNEL_ID_IQAMAH_ALERTS\",\n  \"topic\": \"iqamah5MinuteAlert\",\n  \"minutes\": 5,\n  \"time\": \"2025-08-26T05:45:00.000Z\"\n}\n</code></pre>"},{"location":"server-side/cloud-functions/prayer-times-fetch/","title":"prayerTimesFetch","text":"<p>Type: HTTP Function (onRequest)</p> <p>Endpoint: <code>prayertimesfetch-ilgk6gl75q-uc.a.run.app/</code></p>"},{"location":"server-side/cloud-functions/prayer-times-fetch/#description","title":"Description","text":"<p>Provides daily prayer times formatted for the app. Supports fetching today's or tomorrow's prayer times and handles Asr time according to the selected madhhab.</p>"},{"location":"server-side/cloud-functions/prayer-times-fetch/#query-parameters","title":"Query Parameters","text":"Name Required Values Description <code>day</code> No <code>today</code> (default), <code>tomorrow</code> Selects whether to fetch today's or tomorrow's times. <code>method</code> No <code>hanafi</code>, <code>hanbali</code> If <code>\"hanbali\"</code> is provided, Asr time is fetched from IslamicFinder API. If nothing provided, <code>hanafi</code> is automatically assumed."},{"location":"server-side/cloud-functions/prayer-times-fetch/#environment-variables","title":"Environment Variables","text":"<ul> <li><code>API_LINK</code> \u2013 Base URL for BCMA prayer times</li> <li><code>ISLAMIC_FINDER_API_LINK</code> \u2013 Base URL for IslamicFinder API</li> </ul>"},{"location":"server-side/cloud-functions/prayer-times-fetch/#response-format","title":"Response Format","text":"<p>An array of objects:</p> Field Type Description <code>id</code> string Prayer ID (e.g. <code>fajr</code>, <code>isha</code>) <code>start</code> string Athan time (HH:mm A) <code>iqamah</code> string Iqamah time (HH:mm A) <code>name</code> string English + Arabic prayer name"},{"location":"server-side/cloud-functions/prayer-times-fetch/#example-http-response","title":"Example HTTP Response","text":"<pre><code>[\n  {\n    \"id\": \"fajr\",\n    \"start\": \"04:02 AM\",\n    \"iqamah\": \"05:00 AM\",\n    \"name\": \"Fajr - \u0627\u0644\u0641\u062c\u0631\"\n  },\n  {\n    \"id\": \"shurooq\",\n    \"start\": \"06:03 AM\",\n    \"iqamah\": \"06:03 AM\",\n    \"name\": \"Shurooq - \u0627\u0644\u0634\u0631\u0648\u0642\"\n  },\n  {\n    \"id\": \"duhr\",\n    \"start\": \"01:04 PM\",\n    \"iqamah\": \"01:30 PM\",\n    \"name\": \"Duhr - \u0627\u0644\u0638\u0647\u0631\"\n  },\n  {\n    \"id\": \"asr\",\n    \"start\": \"05:48 PM\",\n    \"iqamah\": \"06:15 PM\",\n    \"name\": \"Asr - \u0627\u0644\u0639\u0635\u0631\"\n  },\n  {\n    \"id\": \"maghrib\",\n    \"start\": \"08:00 PM\",\n    \"iqamah\": \"08:00 PM\",\n    \"name\": \"Maghrib - \u0627\u0644\u0645\u063a\u0631\u0628\"\n  },\n  {\n    \"id\": \"isha\",\n    \"start\": \"09:35 PM\",\n    \"iqamah\": \"09:50 PM\",\n    \"name\": \"Isha - \u0627\u0644\u0639\u0634\u0627\u0621\"\n  },\n  {\n    \"id\": \"jumuah\",\n    \"start\": \"01:30 PM\",\n    \"iqamah\": \"01:30 PM\",\n    \"name\": \"Jumuah - \u0627\u0644\u062c\u0645\u0639\u0629\"\n  }\n]\n</code></pre>"},{"location":"server-side/cloud-functions/send-prayer-alert/","title":"sendPrayerAlert","text":"<p>Type: Task Queue Function (onTaskDispatched)</p>"},{"location":"server-side/cloud-functions/send-prayer-alert/#description","title":"Description","text":"<p>Handles queued payloads created by <code>prayerTimesAlertScheduler</code> and sends localized push notifications for athan and iqamah reminders.</p>"},{"location":"server-side/cloud-functions/send-prayer-alert/#retry-and-rate-limits","title":"Retry and Rate Limits","text":"<ul> <li>Retries: max 3 attempts</li> <li>Backoff: 30 seconds minimum</li> <li>Max concurrent dispatches: 5</li> </ul>"},{"location":"server-side/cloud-functions/send-prayer-alert/#payload-parameters","title":"Payload Parameters","text":"Name Type Description <code>id</code> string Prayer ID (<code>fajr</code>, <code>duhr</code>, <code>asr</code>, <code>maghrib</code>, <code>isha</code>, <code>jumuah</code>) <code>type</code> string <code>\"athan\"</code> or <code>\"iqamah\"</code> <code>androidChannel</code> string Android notification channel ID <code>topic</code> string FCM topic name <code>minutes</code> number Minutes before iqamah (if applicable) <code>time</code> Date Scheduled notification time"},{"location":"server-side/cloud-functions/send-prayer-alert/#notification-behavior","title":"Notification Behavior","text":"<ul> <li>Sends a localized notification for each supported locale.</li> <li>Uses <code>locale.json</code> to translate prayer names and notification text.</li> <li>Plays Athan sound for athan notifications (<code>athan_full</code> on Android, <code>athan_short.caf</code> on iOS).</li> </ul>"},{"location":"server-side/cloud-functions/send-prayer-alert/#example-notification-payload","title":"Example Notification Payload","text":"<p>This notification payload is sent to Firebase Messaging which delivers it to the mobile apps and the web kiosk app.</p> <pre><code>{\n  \"condition\": \"'athanAlert' in topics &amp;&amp; 'lang-en' in topics\",\n  \"notification\": {\n    \"title\": \"Fajr - Athan\",\n    \"body\": \"Time for Fajr prayer\"\n  },\n  \"android\": {\n    \"notification\": {\n      \"channelId\": \"ANDROID_CHANNEL_ID_ATHAN_ALERTS\",\n      \"sound\": \"athan_full\"\n    }\n  },\n  \"apns\": {\n    \"payload\": {\n      \"aps\": {\n        \"sound\": \"athan_short.caf\"\n      }\n    }\n  },\n  \"data\": {\n    \"notificationType\": \"athan\",\n    \"topic\": \"athanAlert\"\n  }\n}\n</code></pre>"},{"location":"server-side/development/deployment/","title":"Deployment","text":"<p>This guide explains how to deploy Firebase Cloud Functions after you are done making changes.</p> <p>Ensure you either have access to the actual KIC Firebase project if you are an active maintainer or you have your own Firebase project set up and configured.</p> <p>Danger</p> <p>This is a guide on how to deploy to a production environment. Ensure you have properly tested all API routes, functions, and Firestore documents before proceeding, or that you are deploying to a sandbox environment.</p>"},{"location":"server-side/development/deployment/#emulator-testing","title":"Emulator Testing","text":"<p>Before deployment, ensure your functions run properly. Test functions locally before production.</p> <pre><code>npm run serve\n</code></pre> <p>Warning</p> <p>Firebase messaging always operates in production. If you send a notification in your emulator while testing to a live production topic, all your clients will receive that notification despite the function running in an emulator.</p>"},{"location":"server-side/development/deployment/#prerequisites","title":"Prerequisites","text":"<p>Start by ensuring you have the Firebase CLI installed and configured. If you tested your functions, this should already be installed, as the emulator also requires the Firebase CLI to be installed.</p> <pre><code>npm install -g firebase-tools\n</code></pre> <p>Once installed, you will also have to link the project to your Firebase project with:</p> <pre><code>firebase use --add\n</code></pre>"},{"location":"server-side/development/deployment/#deploy","title":"Deploy","text":"<p>Build the project.</p> <p>This also runs the linter, ensuring you do not have syntax or style mistakes within your project.</p> <pre><code>npm run build\n</code></pre> <p>Once built, you can deploy all the functions by running the deploy script:</p> <pre><code>npm run deploy\n</code></pre> <p>or by deploying each function individually:</p> <pre><code>firebase deploy --only functions:prayerTimesFetch\n</code></pre> <p>Once deployed, your changes should be live within your Firebase project. You can verify that everything went smoothly by reading the function logs.</p> <pre><code>npm run logs\n</code></pre> <p>\ud83c\udf89 Congratulations, you have deployed the Cloud Functions successfully.</p>"},{"location":"server-side/development/installation/","title":"Installation","text":"<p>This guide explains how to set up the cloud-functions repository for local development, configure Firebase, and run the project in an emulator before deployment.</p>"},{"location":"server-side/development/installation/#prerequisites","title":"Prerequisites","text":"<p>Before starting, make sure you have the following installed and configured on your machine:</p> <p>Node.js v20+</p> <p>Required for running and building Firebase Cloud Functions.</p> <p>Firebase CLI</p> <p>Install it globally with:</p> <pre><code>npm install -g firebase-tools\n</code></pre> <p>Firebase Project Access</p> <p>You need access to either:</p> <ul> <li>The official KIC Firebase project (if you are a maintainer), or</li> <li>Your own Firebase project (for testing and development).</li> </ul>"},{"location":"server-side/development/installation/#repository-structure","title":"Repository Structure","text":"<p>The repository is structured as follows:</p> <pre><code>functions/\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 announcementAlert.ts           # Sends notifications for new announcements\n\u2502   \u251c\u2500\u2500 prayerTimesAlertScheduler.ts   # Schedules daily prayer notifications\n\u2502   \u251c\u2500\u2500 sendPrayerAlert.ts             # Dispatches queued notifications\n\u2502   \u251c\u2500\u2500 prayerTimesFetch.ts            # HTTP endpoint for prayer times\n\u2502   \u2514\u2500\u2500 locale.json                    # Localization strings for notifications\n\u251c\u2500\u2500 package.json                       # NPM dependencies and scripts\n\u2514\u2500\u2500 tsconfig.json                      # TypeScript configuration\n</code></pre> <ul> <li>All Cloud Functions are written in TypeScript and located in the <code>src/</code> directory.</li> <li><code>locale.json</code> stores internationalized strings used in push notifications.</li> </ul>"},{"location":"server-side/development/installation/#setup-steps","title":"Setup Steps","text":""},{"location":"server-side/development/installation/#1-clone-the-repository","title":"1. Clone the Repository","text":"<p>Clone the repo from GitHub and navigate into the project folder:</p> <pre><code>git clone https://github.com/Kelowna-Islamic-Center/cloud-functions\ncd cloud-functions/functions\n</code></pre>"},{"location":"server-side/development/installation/#2-install-dependencies","title":"2. Install Dependencies","text":"<p>Install all required dependencies:</p> <pre><code>npm install\n</code></pre>"},{"location":"server-side/development/installation/#3-configure-firebase-environment","title":"3. Configure Firebase Environment","text":"<p>The functions depend on environment variables for API endpoints and notification channel IDs. Configure them with:</p> <pre><code>firebase functions:config:set \\\n  API_LINK=\"https://org.thebcma.com/api/Prayertimes/GetPrayertimeByDate?organizationId=7&amp;dt=\" \\\n  ISLAMIC_FINDER_API_LINK=\"https://www.islamicfinder.us/index.php/api/prayer_times?latitude=49.8863&amp;longitude=119.4966&amp;timezone=america/vancouver&amp;method=2&amp;juristic=0&amp;time_format=0&amp;date=\" \\\n  PRAYER_TIMES_FETCH_URL=\"https://prayertimesfetch-ilgk6gl75q-uc.a.run.app\" \\\n  ANDROID_CHANNEL_ID_ATHAN_ALERTS=\"athan_alert_channel\" \\\n  ANDROID_CHANNEL_ID_ANNOUNCEMENTS=\"announcements_channel\" \\\n  ANDROID_CHANNEL_ID_IQAMAH_ALERTS=\"iqamah_alert_channel\"\n</code></pre> <p>Verify the configuration was set correctly:</p> <pre><code>firebase functions:config:get\n</code></pre>"},{"location":"server-side/development/installation/#4-run-locally-emulator","title":"4. Run Locally (Emulator)","text":"<p>To emulate the functions locally:</p> <pre><code>npm run serve\n</code></pre> <p>This will start the Firebase Emulator Suite, allowing you to test HTTP-triggered and scheduled functions before deploying.</p> <p>Warning</p> <p>Firebase messaging always operates in production. If you send a notification while testing in the emulator, all subscribed clients will still receive it. Be careful when working with notification-related functions.</p>"},{"location":"server-side/development/installation/#emulator-testing-workflow","title":"Emulator Testing Workflow","text":"<p>The Firebase Emulator allows you to test each function before deploying. Below are examples of how to test the main functions included in this project.</p>"},{"location":"server-side/development/installation/#1-testing-prayertimesfetch-http-function","title":"1. Testing <code>prayerTimesFetch</code> (HTTP Function)","text":"<p>Once the emulator is running, you should see a link in your terminal for testing this function. Open this link in your browser or by querying it through <code>curl</code> and you should see the response of the HTTP function.</p>"},{"location":"server-side/development/installation/#2-testing-announcementalert-firestore-trigger","title":"2. Testing <code>announcementAlert</code> (Firestore Trigger)","text":"<p>This function runs when a new announcement document is created.</p> <ol> <li>Open the Emulator UI (usually at http://127.0.0.1:4000).</li> <li>Navigate to Firestore \u2192 Add Document.</li> <li>Add a new document in the <code>announcements</code> collection.</li> </ol> <p>Warning</p> <p>Ensure you have configured a non-production notification channel (ex. announcmenetsDev) before testing this.</p> <p>The function will automatically trigger and attempt to send a notification. Check logs:</p> <pre><code>npm run logs\n</code></pre>"},{"location":"server-side/development/installation/#3-testing-prayertimesalertscheduler-scheduled-function","title":"3. Testing <code>prayerTimesAlertScheduler</code> (Scheduled Function)","text":"<p>Since schedules don\u2019t fire automatically in the emulator, you need to invoke this manually:</p> <pre><code>firebase functions:shell\n</code></pre> <p>Inside the shell, run:</p> <pre><code>prayerTimesAlertScheduler()\n</code></pre> <p>This simulates the daily scheduled execution. You should see log output showing that notifications were queued.</p>"},{"location":"server-side/development/installation/#4-testing-sendprayeralert-task-queue-function","title":"4. Testing <code>sendPrayerAlert</code> (Task Queue Function)","text":"<p>This function is normally triggered by the scheduler, but you can also invoke it manually:</p> <pre><code>firebase functions:shell\n</code></pre> <pre><code>sendPrayerAlert({ # You params })\n</code></pre> <p>The function will simulate sending a localized prayer alert.</p>"},{"location":"server-side/development/installation/#next-steps","title":"Next Steps","text":"<p>Once installation and local testing are complete, follow the Deployment Guide to push your changes to Firebase.</p>"}]}